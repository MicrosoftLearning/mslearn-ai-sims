<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Learning Lab</title>
    <link rel="stylesheet" href="styles.css?v=12">
    
    <!-- PyScript CSS and JS (2024.1.1) -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <!-- PyScript Configuration -->
    <py-config>
        packages = ["pandas", "numpy", "scikit-learn"]
    </py-config>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="header-title">
                <h1>Machine Learning Lab</h1>
            </div>
        </div>
        <div class="header-right">
            <div id="global-pyscript-status" class="status-loading">
                <div class="loading-spinner"></div>
                <span>Loading PyScript ML libraries...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="hamburger-menu" onclick="toggleSidebar()" data-tooltip="Toggle navigation menu">
                    ☰
                </button>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-item active" onclick="showMyAccountPage()" data-tooltip="ML App">
                        <span class="nav-icon">&#128470;</span>
                        <span class="nav-text">ML App</span>
                    </div>
                </div>
                
                <div class="nav-section" id="home-nav-section" style="display: none;">
                    <div class="nav-item" onclick="showHomePage()" data-tooltip="Home">
                        <span class="nav-icon">⌂</span>
                        <span class="nav-text">Home</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <h3>Authoring</h3>
                    <div class="nav-item" onclick="showAutoMLPage()" data-tooltip="Automated ML">
                        <span class="nav-icon">⚙</span>
                        <span class="nav-text">Automated ML</span>
                    </div>
                </div>

                <div class="nav-section">
                    <h3>Assets</h3>
                    <div class="nav-item" onclick="showDataPage()" data-tooltip="Data">
                        <span class="nav-icon">▤</span>
                        <span class="nav-text">Data</span>
                    </div>
                    <div class="nav-item" onclick="showJobsPage()" data-tooltip="Jobs">
                        <span class="nav-icon">&#128710;</span>
                        <span class="nav-text">Jobs</span>
                    </div>
                    <div class="nav-item" onclick="showModelsPage()" data-tooltip="Models">
                        <span class="nav-icon">◻</span>
                        <span class="nav-text">Models</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- ML App Page -->
            <div id="my-account-page" class="page-content" style="display: block;">
                <div class="ml-app-content">
                    <div class="ml-app-header">
                        <h1 class="welcome-heading">Welcome</h1>
                        <button class="create-workspace-btn" onclick="createWorkspace()">Create workspace</button>
                    </div>
                    <div class="workspaces-section">
                        <h2 class="workspaces-subtitle">Workspaces</h2>
                        <div id="workspaces-list" class="workspaces-list">
                            <!-- Workspace buttons will be dynamically added here -->
                        </div>
                    </div>
                    <div class="home-gallery">
                        <div class="gallery-item">
                            <div class="image-placeholder data-viz">
                                <div class="chart-bars">
                                    <div class="bar" style="height: 60%"></div>
                                    <div class="bar" style="height: 80%"></div>
                                    <div class="bar" style="height: 40%"></div>
                                    <div class="bar" style="height: 90%"></div>
                                    <div class="bar" style="height: 70%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder ml-network">
                                <div class="network-nodes">
                                    <div class="node"></div>
                                    <div class="node"></div>
                                    <div class="node"></div>
                                    <div class="node"></div>
                                    <div class="node"></div>
                                    <div class="node"></div>
                                </div>
                                <div class="network-connections"></div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder data-table">
                                <div class="table-header"></div>
                                <div class="table-row"></div>
                                <div class="table-row"></div>
                                <div class="table-row"></div>
                                <div class="table-row"></div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder algorithm">
                                <div class="algo-flow">
                                    <div class="flow-box"></div>
                                    <div class="flow-arrow">→</div>
                                    <div class="flow-box"></div>
                                    <div class="flow-arrow">→</div>
                                    <div class="flow-box"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Home Page -->
            <div id="home-page" class="page-content" style="display: none;">
                <div class="home-content">
                    <h1 id="workspace-title" class="workspace-title">Workspace</h1>
                    <div class="home-gallery">
                        <div class="gallery-item">
                            <div class="image-placeholder ml-model">
                                <div class="model-layers">
                                    <div class="layer input-layer">
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                    </div>
                                    <div class="layer hidden-layer">
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                    </div>
                                    <div class="layer output-layer">
                                        <div class="neuron"></div>
                                        <div class="neuron"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder prediction-chart">
                                <div class="prediction-line">
                                    <div class="data-point" style="left: 10%; bottom: 20%;"></div>
                                    <div class="data-point" style="left: 25%; bottom: 45%;"></div>
                                    <div class="data-point" style="left: 40%; bottom: 35%;"></div>
                                    <div class="data-point" style="left: 55%; bottom: 60%;"></div>
                                    <div class="data-point" style="left: 70%; bottom: 75%;"></div>
                                    <div class="data-point" style="left: 85%; bottom: 80%;"></div>
                                    <div class="trend-line"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder feature-matrix">
                                <div class="matrix-grid">
                                    <div class="matrix-cell high"></div>
                                    <div class="matrix-cell low"></div>
                                    <div class="matrix-cell medium"></div>
                                    <div class="matrix-cell high"></div>
                                    <div class="matrix-cell medium"></div>
                                    <div class="matrix-cell low"></div>
                                    <div class="matrix-cell high"></div>
                                    <div class="matrix-cell medium"></div>
                                    <div class="matrix-cell low"></div>
                                    <div class="matrix-cell high"></div>
                                    <div class="matrix-cell medium"></div>
                                    <div class="matrix-cell high"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <div class="image-placeholder clustering">
                                <div class="cluster-group group1">
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-center"></div>
                                </div>
                                <div class="cluster-group group2">
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-center"></div>
                                </div>
                                <div class="cluster-group group3">
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-point"></div>
                                    <div class="cluster-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Page -->
            <div id="data-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <h1>Data</h1>
                    <p>Manage your uploaded datasets and explore their contents.</p>
                </div>

                <div class="data-section">
                    <div id="data-files-list" class="data-files-list">
                        <div class="empty-state">
                            <div class="empty-state-content">
                                <h3>No data files uploaded yet.</h3>
                                <p>Upload CSV files through the Automated ML job wizard to see them here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div id="jobs-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <h1>Jobs</h1>
                    <p>Monitor and manage all your machine learning training jobs.</p>
                </div>

                <div class="jobs-section">
                    <div id="jobs-page-list" class="jobs-list">
                        <div class="empty-state">
                            <div class="empty-state-content">
                                <h3>No jobs yet.</h3>
                                <p>Create jobs from the Automated ML page to see them here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Models Page -->
            <div id="models-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <h1>Models</h1>
                    <p>Manage your deployed machine learning models and view their details.</p>
                </div>

                <div class="models-section">
                    <div id="deployed-models-list" class="deployed-models-list">
                        <div class="empty-state">
                            <div class="empty-state-content">
                                <h3>No models deployed yet.</h3>
                                <p>Deploy models from Automated ML training results to see them here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Details Page -->
            <div id="job-details-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="job-header-content">
                        <div class="job-title-section">
                            <div class="job-title-row">
                                <h1 id="job-details-title">ML Job 1</h1>
                                <div class="job-status-badge" id="job-status-badge">
                                    <span class="status-icon">●</span>
                                    <span id="job-status-text">Running</span>
                                </div>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="btn btn-secondary" onclick="refreshJob()" data-tooltip="Refresh job status">
                                <span class="icon">↻</span> Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="registerModel()" data-tooltip="Register best model">
                                + Register model
                            </button>
                        </div>
                    </div>
                </div>

                <div class="job-details-content">
                    <div class="job-tabs">
                        <button class="tab-button active" onclick="showJobTab('overview')" data-tooltip="Job overview and status">Overview</button>
                        <button class="tab-button" onclick="showJobTab('data-guardrails')" data-tooltip="Data quality checks">Data guardrails</button>
                        <button class="tab-button" onclick="showJobTab('models')" data-tooltip="Trained models and results">Models + child jobs</button>
                        <button class="tab-button" onclick="showJobTab('outputs')" data-tooltip="Job outputs and artifacts">Outputs + logs</button>
                        <button class="tab-button" onclick="showJobTab('child-jobs')" data-tooltip="Individual model training runs">Child jobs</button>
                    </div>

                    <div class="job-tab-content">
                        <!-- Overview Tab -->
                        <div id="overview-tab" class="tab-panel active">
                            <div class="job-overview-layout">
                                <div class="job-overview-left">
                                    <div class="properties-section">
                                        <h3>Properties</h3>
                                        <div class="property-grid">
                                            <div class="property-item">
                                                <label>Status</label>
                                                <div class="status-with-icon" id="properties-status">
                                                    <span class="status-icon">●</span>
                                                    <span>Running</span>
                                                </div>
                                            </div>
                                            <div class="property-item">
                                                <label>Job type</label>
                                                <span id="properties-job-type">Automated ML</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Created on</label>
                                                <span id="properties-created-on">Oct 15, 2025 6:51 PM</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Start time</label>
                                                <span id="properties-start-time">Oct 15, 2025 6:51 PM</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Name</label>
                                                <span id="properties-name">loving_farm_xd1wx3tyn6</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="job-overview-right">
                                    <div class="inputs-section">
                                        <h3>Inputs</h3>
                                        <div class="input-item">
                                            <div class="input-header">
                                                <span class="input-label">Input name: training_data</span>
                                            </div>
                                            <div class="input-details">
                                                <span class="input-type">Data asset: </span>
                                                <span id="input-data-asset">penguin-data:1</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="best-model-section">
                                        <h3>Best model summary</h3>
                                        <div id="best-model-content">
                                            <div class="no-data-message">
                                                <span class="no-data-icon">ℹ</span>
                                                <span>No data</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="run-summary-section">
                                        <h3>Run summary</h3>
                                        <div class="summary-grid">
                                            <div class="summary-item">
                                                <label>Task type</label>
                                                <div class="task-type-content">
                                                    <span id="summary-task-type">Classification</span>
                                                    <a href="#" onclick="viewConfigSettings()" class="config-link">⚙ View configuration settings</a>
                                                </div>
                                            </div>
                                            <div class="summary-item">
                                                <label>Featurization</label>
                                                <span id="summary-featurization">Auto</span>
                                            </div>
                                            <div class="summary-item">
                                                <label>Primary metric</label>
                                                <span id="summary-primary-metric">AUC weighted</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Other tabs would go here -->
                        <div id="data-guardrails-tab" class="tab-panel" style="display: none;">
                            <div class="tab-content-placeholder">
                                <h4>Data guardrails</h4>
                                <p>Data quality checks and validation results will appear here.</p>
                            </div>
                        </div>

                        <div id="models-tab" class="tab-panel" style="display: none;">
                            <div id="models-results-content">
                                <h4>Model Results</h4>
                                <div id="job-model-results"></div>
                            </div>
                        </div>

                        <div id="outputs-tab" class="tab-panel" style="display: none;">
                            <div id="outputs-content">
                                <div class="logs-placeholder">
                                    <div class="logs-placeholder-icon">ℹ</div>
                                    <div class="logs-placeholder-text">No logs available</div>
                                    <div class="logs-placeholder-subtext">Training logs will appear here after job completion</div>
                                </div>
                            </div>
                        </div>

                        <div id="child-jobs-tab" class="tab-panel" style="display: none;">
                            <div class="tab-content-placeholder">
                                <h4>Child jobs</h4>
                                <p>Individual model training runs will appear here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Child Job Details Page -->
            <div id="child-job-details-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="job-header-content">
                        <div class="job-title-section">
                            <div class="job-title-row">
                                <button class="btn btn-link back-button" onclick="backToParentJob()" data-tooltip="Back to parent job">
                                    ← Back to parent job
                                </button>
                                <h1 id="child-job-details-title">ML-Job-1-Child1</h1>
                                <div class="job-status-badge" id="child-job-status-badge">
                                    <span class="status-icon">●</span>
                                    <span id="child-job-status-text">Completed</span>
                                </div>
                            </div>
                        </div>
                        <div class="job-actions">
                            <button class="btn btn-secondary" onclick="refreshChildJob()" data-tooltip="Refresh job status">
                                <span class="icon">↻</span> Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="registerChildModel()" data-tooltip="Register this model">
                                + Register model
                            </button>
                        </div>
                    </div>
                </div>

                <div class="job-details-content">
                    <div class="job-tabs">
                        <button class="tab-button active" onclick="showChildJobTab('overview')" data-tooltip="Job overview and status">Overview</button>
                        <button class="tab-button" onclick="showChildJobTab('model')" data-tooltip="Model details and metrics">Model</button>
                        <button class="tab-button" onclick="showChildJobTab('metrics')" data-tooltip="Performance metrics">Metrics</button>
                        <button class="tab-button" onclick="showChildJobTab('outputs')" data-tooltip="Job outputs and logs">Outputs + logs</button>
                    </div>

                    <div class="job-tab-content">
                        <!-- Child Job Overview Tab -->
                        <div id="child-overview-tab" class="tab-panel active">
                            <div class="job-overview-layout">
                                <div class="job-overview-left">
                                    <div class="properties-section">
                                        <h3>Properties</h3>
                                        <div class="property-grid">
                                            <div class="property-item">
                                                <label>Status</label>
                                                <div class="status-with-icon" id="child-properties-status">
                                                    <span class="status-icon">●</span>
                                                    <span>Completed</span>
                                                </div>
                                            </div>
                                            <div class="property-item">
                                                <label>Created on</label>
                                                <span id="child-properties-created-on">Oct 17, 2025 2:19 PM</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Duration</label>
                                                <span id="child-properties-duration">28.84s</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Compute target</label>
                                                <span id="child-properties-compute-target">Serverless</span>
                                            </div>
                                            <div class="property-item">
                                                <label>Name</label>
                                                <span id="child-properties-name">ML-Job-1</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="job-overview-right">
                                    <div class="inputs-section">
                                        <h3>Inputs</h3>
                                        <div class="input-item">
                                            <div class="input-header">
                                                <span class="input-label">Input name: training_data</span>
                                            </div>
                                            <div class="input-details">
                                                <span class="input-type">Data asset: </span>
                                                <span id="child-input-data-asset">Seeds</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="outputs-section">
                                        <h3>Outputs</h3>
                                        <div class="output-item">
                                            <div class="output-header">
                                                <span class="output-label" id="child-output-name">Output name: model_12345</span>
                                            </div>
                                            <div class="output-details">
                                                <span class="output-type">Model asset: </span>
                                                <span id="child-output-model-asset">model_12345</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Child Job Model Tab -->
                        <div id="child-model-tab" class="tab-panel" style="display: none;">
                            <div id="child-model-content">
                                <h4>Model Details</h4>
                                <div id="child-model-info"></div>
                            </div>
                        </div>

                        <!-- Child Job Metrics Tab -->
                        <div id="child-metrics-tab" class="tab-panel" style="display: none;">
                            <div id="child-metrics-content">
                                <h4>Model Performance Metrics</h4>
                                <div id="child-metrics-display"></div>
                            </div>
                        </div>

                        <!-- Child Job Outputs Tab -->
                        <div id="child-outputs-tab" class="tab-panel" style="display: none;">
                            <div id="child-outputs-content">
                                <div class="logs-placeholder">
                                    <div class="logs-placeholder-icon">ℹ</div>
                                    <div class="logs-placeholder-text">No logs available</div>
                                    <div class="logs-placeholder-subtext">Training logs will appear here after job completion</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Automated ML Page -->
            <div id="automl-page" class="page-content" style="display: none;">
                <div class="page-header">
                    <h1>Automated ML</h1>
                    <p>Let Automated ML train and find the best model based on your data without writing a single line of code. <a href="https://aka.ms/mslearn-azure-ml-intro" target="_blank" class="learn-more-link">Learn more about Automated ML</a></p>
                </div>
                
                <div class="action-bar">
                    <button class="btn btn-primary" onclick="openNewJobWizard()" data-tooltip="Start a new Automated ML training job">
                        + New Automated ML job
                    </button>
                    <button class="btn btn-secondary" onclick="refreshJobs()" data-tooltip="Refresh the list of jobs">
                        <span class="icon">↻</span> Refresh
                    </button>
                </div>

                <div class="jobs-section">
                    <div id="jobs-list" class="jobs-list">
                        <div class="empty-state">
                            <div class="empty-state-content">
                                <h3>No recent Automated ML jobs to display.</h3>
                                <p>Click "New Automated ML job" to create your first job.</p>
                                <a href="https://aka.ms/mslearn-azure-ml-intro" target="_blank" class="learn-more-link">📚 Learn more about creating Automated ML jobs</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="documentation-section">
                    <h3>Documentation</h3>
                    <div class="doc-links">
                        <a href="https://aka.ms/mslearn-ml-concepts" target="_blank" class="doc-link">
                            <span class="doc-icon">📖</span>
                            <span>Concept: What is Machine Learning?</span>
                        </a>
                        <a href="https://aka.ms/mslearn-azure-ml-intro" target="_blank" class="doc-link">
                            <span class="doc-icon">🎓</span>
                            <span>Tutorial: Get started with Machine Learning on Azure</span>
                        </a>
                        <a href="https://azure.microsoft.com/products/machine-learning/" target="_blank" class="doc-link">
                            <span class="doc-icon">📝</span>
                            <span>On the web: Microsoft Azure Machine Learning</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Job Wizard Modal -->
            <div id="job-wizard-modal" class="modal full-page-modal">
                <div class="full-page-wizard">
                    <div class="wizard-header">
                        <h1>Submit an Automated ML job</h1>
                        <button class="close-wizard" onclick="closeJobWizard()" data-tooltip="Cancel job creation">&times;</button>
                    </div>
                    
                    <div class="wizard-main">
                        <div class="wizard-sidebar">
                            <div class="wizard-steps-vertical">
                                <div class="step-vertical active" data-step="1">
                                    <div class="step-indicator">
                                        <span class="step-number">1</span>
                                    </div>
                                    <div class="step-info">
                                        <div class="step-title">Basic settings</div>
                                    </div>
                                </div>
                                <div class="step-vertical" data-step="2">
                                    <div class="step-indicator">
                                        <span class="step-number">2</span>
                                    </div>
                                    <div class="step-info">
                                        <div class="step-title">Task type & data</div>
                                    </div>
                                </div>
                                <div class="step-vertical" data-step="3">
                                    <div class="step-indicator">
                                        <span class="step-number">3</span>
                                    </div>
                                    <div class="step-info">
                                        <div class="step-title">Task settings</div>
                                    </div>
                                </div>
                                <div class="step-vertical" data-step="4">
                                    <div class="step-indicator">
                                        <span class="step-number">4</span>
                                    </div>
                                    <div class="step-info">
                                        <div class="step-title">Compute</div>
                                    </div>
                                </div>
                                <div class="step-vertical" data-step="5">
                                    <div class="step-indicator">
                                        <span class="step-number">5</span>
                                    </div>
                                    <div class="step-info">
                                        <div class="step-title">Review</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wizard-content-area">
                            <!-- Step 1: Basic Settings -->
                            <div id="step-1" class="wizard-step active">
                                <div class="step-header">
                                    <h2>Basic settings</h2>
                                    <p>Let's start with some basic information about your training job.</p>
                                </div>
                                <div class="step-content">
                                    <div class="form-section">
                                        <div class="form-group">
                                            <label for="job-name">Job name *</label>
                                            <input type="text" id="job-name" placeholder="Enter job name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="job-description">Description</label>
                                            <textarea id="job-description" rows="4" placeholder="Enter description (optional)"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Task & Data -->
                            <div id="step-2" class="wizard-step">
                                <div class="step-header">
                                    <h2>Task type & data</h2>
                                    <p>Select the machine learning task type and upload your data.</p>
                                </div>
                                <div class="step-content">
                                    <div class="form-section">
                                        <div class="form-group">
                                            <label for="task-type">Task type *</label>
                                            <div class="custom-dropdown" data-tooltip="Choose the type of machine learning task">
                                                <div class="dropdown-selected" id="task-type-selected" onclick="toggleTaskTypeDropdown()">
                                                    <span class="placeholder">Select task type</span>
                                                    <span class="dropdown-arrow">▼</span>
                                                </div>
                                                <div class="dropdown-options" id="task-type-options">
                                                    <div class="task-type-option" data-value="classification" onclick="selectTaskType('classification')">
                                                        <div class="task-type-icon chart"></div>
                                                        <span>Classification</span>
                                                    </div>
                                                    <div class="task-type-option" data-value="regression" onclick="selectTaskType('regression')">
                                                        <div class="task-type-icon layers"></div>
                                                        <span>Regression</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="task-type" value="">
                                            <div class="help-text">
                                                <small><strong>Classification:</strong> Predict categories (e.g., spam/not spam, pass/fail)</small><br>
                                                <small><strong>Regression:</strong> Predict continuous values (e.g., price, temperature)</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Create Dataset Button -->
                                        <div class="form-group">
                                            <button type="button" class="btn btn-primary" onclick="showCreateDatasetInterface()" data-tooltip="Create a new tabular dataset">
                                                Create (Tabular)
                                            </button>
                                        </div>
                                        
                                        <!-- Existing Datasets List -->
                                        <div class="form-group">
                                            <label>Select existing dataset</label>
                                            <div id="dataset-list" class="dataset-list">
                                                <div class="no-datasets">
                                                    <p>No datasets available. Create a dataset using the button above.</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- File Upload (Hidden initially, shown when Create button is clicked) -->
                                        <div class="form-group" id="file-upload-group" style="display: none;">
                                            <label for="dataset-name">Dataset name *</label>
                                            <input type="text" id="dataset-name" placeholder="Enter dataset name" oninput="validateDatasetName()">
                                            <div id="dataset-name-error" class="error-message" style="display: none;"></div>
                                            
                                            <label for="data-file" style="margin-top: 15px;">Upload CSV file *</label>
                                            <input type="file" id="data-file" accept=".csv" onchange="handleFileUpload(this)">
                                            <div id="uploaded-files"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Task Settings -->
                            <div id="step-3" class="wizard-step">
                                <div class="step-header">
                                    <h2>Task settings</h2>
                                    <p>Configure additional settings for your machine learning task.</p>
                                </div>
                                <div class="step-content">
                                    <div class="form-section">
                                        <div class="form-group" id="target-column-group" style="display: none;">
                                            <label for="target-column">Target column *</label>
                                            <select id="target-column">
                                                <option value="">Select target column</option>
                                            </select>
                                        </div>
                                        <div class="config-section horizontal">
                                            <div class="config-item">
                                                <button type="button" class="config-btn" onclick="openConfigFlyout()" data-tooltip="Configure primary metrics and algorithms">
                                                    <span class="config-icon">⚙️</span>
                                                    <div>
                                                        <div class="config-title">Additional configuration settings</div>
                                                        <div class="config-desc">Primary metric and algorithms</div>
                                                    </div>
                                                </button>
                                            </div>
                                            <div class="config-item">
                                                <button type="button" class="config-btn" onclick="openFeaturizationFlyout()" data-tooltip="Configure data preprocessing options">
                                                    <span class="config-icon">🔧</span>
                                                    <div>
                                                        <div class="config-title">Featurization settings</div>
                                                        <div class="config-desc">Data preprocessing options</div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Limits expandable section -->
                                        <div class="expandable-section">
                                            <button type="button" class="expandable-header" onclick="toggleLimitsSection()">
                                                <span class="expand-icon">▶</span>
                                                <span>Limits</span>
                                            </button>
                                            <div id="limits-content" class="expandable-content">
                                                <div class="form-group">
                                                    <label for="metric-threshold">Metric score threshold</label>
                                                    <input type="number" id="metric-threshold" name="metric-threshold" 
                                                           placeholder="e.g., 0.85" step="0.01" min="0" max="1">
                                                    <small class="form-help">Stop training when this metric score is reached (range depends on selected primary metric)</small>
                                                </div>
                                                <div class="form-group">
                                                    <label for="experiment-timeout">Experiment timeout (minutes)</label>
                                                    <input type="number" id="experiment-timeout" name="experiment-timeout" 
                                                           placeholder="e.g., 60" min="15" max="1440">
                                                    <small class="form-help">Maximum time to run the experiment (minimum 15 minutes)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Compute -->
                            <div id="step-4" class="wizard-step">
                                <div class="step-header">
                                    <h2>Compute</h2>
                                    <p>Select the compute target for training your machine learning model.</p>
                                </div>
                                <div class="step-content">
                                    <div class="form-section">
                                        <div class="form-group">
                                            <label for="compute-type">Select compute type</label>
                                            <select id="compute-type" class="form-control">
                                                <option value="serverless" selected>Serverless</option>
                                                <option value="compute-instance" disabled>Compute Instance</option>
                                                <option value="compute-cluster" disabled>Compute Cluster</option>
                                            </select>
                                            <div class="form-help">
                                                <small>Serverless compute is the recommended option for getting started with automated ML.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Review -->
                            <div id="step-5" class="wizard-step">
                                <div class="step-header">
                                    <h2>Review and submit</h2>
                                    <p>Review your configuration and submit the training job.</p>
                                </div>
                                <div class="step-content">
                                    <div class="form-section">
                                        <div id="job-summary"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-footer-full">
                        <div class="footer-left">
                            <button type="button" class="btn btn-secondary" onclick="previousStep()" id="prev-btn" style="display: none;" data-tooltip="Go to previous step">Back</button>
                        </div>
                        <div class="footer-right">
                            <button type="button" class="btn btn-secondary" onclick="closeJobWizard()" data-tooltip="Cancel job creation">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-btn" data-tooltip="Continue to next step">Next</button>
                            <button type="button" class="btn btn-primary" onclick="submitJob()" id="submit-btn" style="display: none;" data-tooltip="Start training the models">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Configuration Flyout -->
    <div id="config-flyout" class="flyout">
        <div class="flyout-header">
            <h3>Additional Configuration Settings</h3>
            <span class="flyout-close" onclick="closeConfigFlyout()">&times;</span>
        </div>
        <div class="flyout-content">
            <div class="form-group">
                <label for="primary-metric">Primary metric</label>
                <select id="primary-metric">
                    <!-- Options will be populated based on task type -->
                </select>
            </div>
            <div class="form-group">
                <label>Algorithms to try</label>
                <div id="algorithms-list" class="checkbox-group">
                    <!-- Checkboxes will be populated based on task type -->
                </div>
            </div>
        </div>
        <div class="flyout-actions" style="margin-top: 24px; padding: 0 24px 24px 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeConfigFlyout()" data-tooltip="Cancel and close configuration">Cancel</button>
            <button type="button" class="btn btn-primary" id="config-save-btn" onclick="saveConfig()" data-tooltip="Save configuration settings" style="background-color: #0078d4 !important; color: white !important; cursor: pointer !important; pointer-events: auto !important;">Save</button>
        </div>
    </div>

    <!-- Featurization Flyout -->
    <div id="featurization-flyout" class="flyout">
        <div class="flyout-header">
            <h3>Featurization Settings</h3>
            <span class="flyout-close" onclick="closeFeaturizationFlyout()">&times;</span>
        </div>
        <div class="flyout-content">
            <div class="form-group">
                <label class="checkbox-label-horizontal">
                    <input type="checkbox" id="normalize-features"> 
                    <span>Normalize numeric features</span>
                </label>
            </div>
            <div class="form-group">
                <label>Handle missing data</label>
                <div class="radio-group-vertical">
                    <label>
                        <input type="radio" name="missing-data-strategy" value="remove" checked>
                        <span>Remove rows with missing values (default)</span>
                    </label>
                    <label>
                        <input type="radio" name="missing-data-strategy" value="impute">
                        <span>Fill missing values (mean for numeric, most frequent for categorical)</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="categorical-columns-group" style="display: none;">
                <label>Non-numeric columns</label>
                <div class="categorical-table-container">
                    <table class="categorical-table">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="categorical-columns">
                            <!-- Non-numeric columns will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flyout-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeFeaturizationFlyout()" data-tooltip="Cancel and close featurization settings">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFeaturization()" data-tooltip="Save featurization settings">Save</button>
            </div>
        </div>
    </div>

    <!-- Model Details Modal -->
    <div id="model-details-modal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="model-title">Model Details</h3>
                <span class="close" onclick="closeModelDetails()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="model-metrics"></div>
                <div id="model-visualization"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModelDetails()" data-tooltip="Close model details">Close</button>
                <button type="button" class="btn btn-primary" onclick="deployModel()" id="deploy-btn" data-tooltip="Deploy this model for predictions">Deploy Model</button>
                <button type="button" class="btn btn-success" onclick="testModel()" id="test-btn" style="display: none;" data-tooltip="Test the deployed model with sample data">Test Model</button>
            </div>
        </div>
    </div>

    <!-- Test Model Modal -->
    <div id="test-model-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Test Model</h3>
                <span class="close" onclick="closeTestModel()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="test-features">Features (JSON)</label>
                    <textarea id="test-features" rows="8" placeholder='{"feature1": value1, "feature2": value2, ...}'></textarea>
                </div>
                <div id="prediction-result"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTestModel()" data-tooltip="Close test model dialog">Close</button>
                <button type="button" class="btn btn-primary" onclick="makePrediction()" data-tooltip="Generate prediction using the model">Predict</button>
            </div>
        </div>
    </div>

    <!-- Training Progress Modal -->
    <div id="training-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Training Models</h3>
            </div>
            <div class="modal-body">
                <div id="training-progress"></div>
                <div id="model-results"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeTrainingModal()" id="training-close-btn" style="display: none;" data-tooltip="Close training results">Close</button>
            </div>
        </div>
    </div>

    <!-- Data Content Modal -->
    <div id="data-content-modal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="data-file-title">Data File Contents</h3>
                <span class="close" onclick="closeDataContentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="data-file-info"></div>
                <div id="data-file-preview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDataContentModal()" data-tooltip="Close data preview">Close</button>
            </div>
        </div>
    </div>

    <!-- Configuration Settings Flyout -->
    <div id="config-settings-flyout" class="flyout">
        <div class="flyout-header">
            <h3>Configuration Settings</h3>
            <span class="flyout-close" onclick="closeConfigSettingsModal()">&times;</span>
        </div>
        <div class="flyout-content">
            <div id="config-settings-content">
                <!-- Configuration details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Flyout Overlay -->
    <div id="flyout-overlay" class="flyout-overlay" onclick="closeAllFlyouts()"></div>

    <!-- PyScript Training Module -->
    <py-script>
        # PyScript initialization and CSV parsing
        import pandas as pd
        import numpy as np
        from io import StringIO
        import json
        import js
        
        print("PyScript starting...")
        print("✓ Basic libraries imported")
        
        # Test DataFrame creation
        test_df = pd.DataFrame({'a': [1, 2, 3], 'b': [4, 5, 6]})
        print(f"✓ Test DataFrame created: {test_df.shape}")
        
        # CSV parsing function
        def parse_csv_with_pyscript(csv_content, file_name, use_first_row_as_headers=True):
            print(f"PyScript parsing CSV: {file_name}, use_headers: {use_first_row_as_headers}")
            try:
                # Parse CSV
                csv_data = StringIO(csv_content)
                
                if use_first_row_as_headers:
                    df = pd.read_csv(csv_data)
                else:
                    # Parse without headers, first row becomes data
                    df = pd.read_csv(csv_data, header=None)
                    # Generate column names
                    df.columns = [f'Column{i+1}' for i in range(len(df.columns))]
                
                print(f"DataFrame shape: {df.shape}")
                print(f"Columns: {list(df.columns)}")
                
                # Basic validation
                if df.empty:
                    raise ValueError("CSV file appears to be empty")
                
                # Get original data types before cleaning
                original_dtypes = df.dtypes.to_dict()
                
                # Detect numeric columns more intelligently
                numeric_columns = []
                for col in df.columns:
                    if pd.api.types.is_numeric_dtype(df[col]):
                        numeric_columns.append(col)
                    else:
                        # Check if it could be numeric but has string NaN values
                        non_null_values = df[col].dropna()
                        if len(non_null_values) > 0:
                            try:
                                pd.to_numeric(non_null_values, errors='raise')
                                numeric_columns.append(col)
                            except (ValueError, TypeError):
                                pass
                
                # Convert dtypes to JSON-serializable format with proper detection
                column_info = {}
                for col in df.columns:
                    if col in numeric_columns:
                        # Check if it's integer or float
                        non_null_values = pd.to_numeric(df[col], errors='coerce').dropna()
                        if len(non_null_values) > 0:
                            if non_null_values.equals(non_null_values.astype(int)):
                                column_info[col] = 'int64'
                            else:
                                column_info[col] = 'float64'
                        else:
                            column_info[col] = 'float64'
                    else:
                        column_info[col] = 'object'
                
                # Clean DataFrame for preview (replace NaN with empty strings only for display)
                df_for_preview = df.fillna('')
                
                # Get column information
                columns = df.columns.tolist()
                print(f"Columns: {columns}")
                print(f"Detected types: {column_info}")
                
                # Get preview data (first 5 rows) with NaN handling
                preview_data = df_for_preview.head().to_dict('records')
                print(f"Preview rows: {len(preview_data)}")
                
                # Return column information to JavaScript
                column_data = {
                    'columns': columns,
                    'dtypes': column_info,  # Use our improved detection
                    'shape': list(df.shape),  # Convert numpy array to list
                    'filename': file_name,
                    'preview': preview_data,
                    'success': True,
                    'parser': 'pandas'
                }
                
                # Store the original DataFrame globally for training
                globals()['current_dataframe'] = df
                globals()['current_filename'] = file_name
                
                # Convert to JSON string with proper handling
                json_data = json.dumps(column_data, default=str)
                js.handleParsedData(json_data)
                print(f"✓ Successfully parsed CSV: {df.shape[0]} rows, {df.shape[1]} columns")
                
            except Exception as e:
                print(f"✗ PyScript CSV parsing error: {str(e)}")
                error_data = {
                    'success': False,
                    'error': str(e),
                    'filename': file_name,
                    'parser': 'pandas'
                }
                json_data = json.dumps(error_data, default=str)
                js.handleParsedData(json_data)
                print(f"✗ CSV parsing failed: {e}")
        
        # Function to update DataFrame with custom headers
        def update_dataframe_headers(custom_headers):
            """Update the stored DataFrame with custom column headers"""
            if 'current_dataframe' in globals():
                df = globals()['current_dataframe']
                if len(custom_headers) == len(df.columns):
                    print(f"Updating DataFrame headers from {list(df.columns)} to {custom_headers}")
                    df.columns = custom_headers
                    globals()['current_dataframe'] = df
                    print("✓ DataFrame headers updated successfully")
                    return True
                else:
                    print(f"✗ Header count mismatch: {len(custom_headers)} vs {len(df.columns)}")
                    return False
            return False
        
        # Make function available to JavaScript
        js.window.parse_csv_with_pyscript = parse_csv_with_pyscript
        js.window.update_dataframe_headers = update_dataframe_headers
        
        # Training function for ML models - Full implementation with all metrics
        def train_ml_models_pyscript(job_data_json, data_info):
            from datetime import datetime
            import numpy as np
            from sklearn.model_selection import train_test_split
            from sklearn.preprocessing import StandardScaler, LabelEncoder
            from sklearn.linear_model import LogisticRegression, LinearRegression, Lasso
            from sklearn.tree import DecisionTreeClassifier, DecisionTreeRegressor
            from sklearn.ensemble import RandomForestClassifier, RandomForestRegressor
            from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
            from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
            from sklearn.metrics import roc_auc_score
            from sklearn.impute import SimpleImputer
            
            # Initialize comprehensive logging system
            training_logs = []
            
            def log_message(message, level="info"):
                """Add a timestamped log entry"""
                # Create timestamp using Python datetime instead of js.Date()
                from datetime import datetime
                timestamp = datetime.now().strftime("%H:%M:%S")
                log_entry = {
                    'timestamp': timestamp,
                    'message': str(message),
                    'level': level
                }
                training_logs.append(log_entry)
                print(f"[{timestamp}] {message}")
            
            log_message("🚀 STARTING AUTOML TRAINING JOB")
            log_message("=" * 50)
            
            try:
                # Parse job data
                job_data = json.loads(job_data_json)
                log_message("📄 Parsing job configuration...")
                
                # Log all job settings with details
                log_message("🔍 JOB CONFIGURATION:")
                log_message(f"  • Target column: {job_data.get('targetColumn')}")
                log_message(f"  • Task type: {job_data.get('taskType')}")
                log_message(f"  • Algorithms: {job_data.get('algorithms', [])}")
                log_message(f"  • Primary metric: {job_data.get('primaryMetric')}")
                log_message(f"  • Normalize features: {job_data.get('normalizeFeatures', False)}")
                log_message(f"  • Categorical settings: {job_data.get('categoricalSettings', {})}")
                
                # Check if we have the DataFrame stored globally
                if 'current_dataframe' not in globals():
                    raise ValueError("No dataframe available for training. Please upload a CSV file first.")
                
                df = globals()['current_dataframe']
                log_message(f"📊 Dataset loaded successfully:")
                log_message(f"  • Shape: {df.shape[0]} rows × {df.shape[1]} columns")
                log_message(f"  • Columns: {list(df.columns)}")
                
                # Get training parameters
                target_column = job_data['targetColumn']
                task_type = job_data['taskType']
                algorithms = job_data.get('algorithms', [])
                primary_metric = job_data.get('primaryMetric', 'accuracy' if task_type == 'classification' else 'mae')
                normalize_features = job_data.get('normalizeFeatures', False)
                categorical_settings = job_data.get('categoricalSettings', {})
                
                log_message("🔄 Preparing training data...")
                
                # Prepare features and target
                X = df.drop(columns=[target_column])
                y = df[target_column]
                log_message(f"  • Features: {X.shape[1]} columns")
                log_message(f"  • Target values: {len(y)} samples")
                log_message(f"  • Target column: '{target_column}'")
                
                # Log data types before processing
                log_message("📋 Data types analysis:")
                categorical_cols = []
                numeric_cols = []
                for col in X.columns:
                    if X[col].dtype == 'object':
                        categorical_cols.append(col)
                    else:
                        numeric_cols.append(col)
                log_message(f"  • Categorical columns: {len(categorical_cols)} - {categorical_cols}")
                log_message(f"  • Numeric columns: {len(numeric_cols)} - {numeric_cols}")
                
                # Handle categorical columns
                log_message("🏷️ Processing categorical variables...")
                for col in X.columns:
                    if col in categorical_settings:
                        if categorical_settings[col] == 'categorize':
                            if X[col].dtype == 'object':
                                le = LabelEncoder()
                                X[col] = le.fit_transform(X[col].astype(str))
                                log_message(f"  • Encoded categorical column: '{col}'")
                        elif categorical_settings[col] == 'ignore':
                            X = X.drop(columns=[col])
                            log_message(f"  • Ignored column: '{col}'")
                
                # Convert remaining object columns to numeric
                for col in X.columns:
                    if X[col].dtype == 'object':
                        le = LabelEncoder()
                        X[col] = le.fit_transform(X[col].astype(str))
                        log_message(f"  • Auto-encoded categorical column: '{col}'")
                
                # Handle missing data based on strategy
                missing_data_strategy = job_data.get('missingDataStrategy', 'remove')
                log_message(f"🧹 Handling missing data (strategy: {missing_data_strategy})...")
                
                # Check for missing values
                missing_count_before = X.isna().sum().sum()
                missing_rows_before = X.isna().any(axis=1).sum()
                log_message(f"  • Missing values found: {missing_count_before} total, {missing_rows_before} rows affected")
                
                if missing_count_before > 0:
                    if missing_data_strategy == 'remove':
                        # Remove rows with any missing values
                        original_shape = X.shape
                        mask = ~X.isna().any(axis=1)
                        X_clean = X[mask].copy()
                        y_clean = y[mask].copy()
                        
                        rows_removed = original_shape[0] - X_clean.shape[0]
                        log_message(f"  • Removed {rows_removed} rows with missing values")
                        log_message(f"  • Dataset shape: {original_shape[0]} → {X_clean.shape[0]} rows ({X_clean.shape[1]} columns)")
                        
                        # Verify no missing values remain
                        remaining_missing = X_clean.isna().sum().sum()
                        if remaining_missing == 0:
                            log_message(f"  ✅ All missing values removed successfully")
                        else:
                            log_message(f"  ⚠️ Warning: {remaining_missing} missing values still remain")
                        
                        X, y = X_clean, y_clean
                        
                    elif missing_data_strategy == 'impute':
                        # Fill missing values (mean for numeric, mode for categorical)
                        from sklearn.impute import SimpleImputer
                        log_message(f"  • Applying imputation strategy...")
                        
                        # Separate numeric and categorical columns
                        numeric_columns = X.select_dtypes(include=[np.number]).columns
                        categorical_columns = X.select_dtypes(exclude=[np.number]).columns
                        
                        if len(numeric_columns) > 0:
                            imputer_numeric = SimpleImputer(strategy='mean')
                            X[numeric_columns] = imputer_numeric.fit_transform(X[numeric_columns])
                            log_message(f"    - Imputed {len(numeric_columns)} numeric columns with mean")
                        
                        if len(categorical_columns) > 0:
                            imputer_categorical = SimpleImputer(strategy='most_frequent')
                            X[categorical_columns] = imputer_categorical.fit_transform(X[categorical_columns])
                            log_message(f"    - Imputed {len(categorical_columns)} categorical columns with mode")
                        
                        remaining_missing = X.isna().sum().sum()
                        if remaining_missing == 0:
                            log_message(f"  ✅ All missing values imputed successfully")
                        else:
                            log_message(f"  ⚠️ Warning: {remaining_missing} missing values still remain")
                else:
                    log_message(f"  ✅ No missing values found - no action needed")
                
                # Create dynamic random state based on job ID and settings
                job_id = job_data.get('id', 1)
                settings_hash = hash(str(normalize_features) + str(categorical_settings) + str(algorithms))
                random_state = abs((job_id + settings_hash) % 10000)
                log_message(f"🎲 Random state: {random_state} (based on job {job_id} and settings)")
                
                # Split data
                log_message("✂️ Splitting data into train/test sets...")
                X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=random_state)
                log_message(f"  • Training set: {X_train.shape[0]} samples ({X_train.shape[0]/(X_train.shape[0]+X_test.shape[0])*100:.1f}%)")
                log_message(f"  • Test set: {X_test.shape[0]} samples ({X_test.shape[0]/(X_train.shape[0]+X_test.shape[0])*100:.1f}%)")
                
                # Show sample data before normalization
                log_message("📊 Data preprocessing analysis:")
                if len(X_train.columns) > 0:
                    sample_col = X_train.columns[0]
                    log_message(f"  • Sample column '{sample_col}' stats before processing:")
                    log_message(f"    - Mean: {X_train[sample_col].mean():.4f}")
                    log_message(f"    - Std: {X_train[sample_col].std():.4f}")
                    log_message(f"    - Min: {X_train[sample_col].min():.4f}")
                    log_message(f"    - Max: {X_train[sample_col].max():.4f}")
                X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=random_state)
                
                print(f"📈 Training data shape: X_train={X_train.shape}, y_train={y_train.shape}")
                print(f"📊 Test data shape: X_test={X_test.shape}, y_test={y_test.shape}")
                
                # Normalize features if requested
                if normalize_features:
                    log_message("⚖️ Applying feature normalization...")
                    scaler = StandardScaler()
                    X_train_scaled = pd.DataFrame(scaler.fit_transform(X_train), columns=X_train.columns, index=X_train.index)
                    X_test_scaled = pd.DataFrame(scaler.transform(X_test), columns=X_test.columns, index=X_test.index)
                    log_message(f"  • StandardScaler fitted on training data")
                    if len(X_train_scaled.columns) > 0:
                        sample_col = X_train_scaled.columns[0]
                        log_message(f"  • Sample column '{sample_col}' after normalization:")
                        log_message(f"    - Mean: {X_train_scaled[sample_col].mean():.4f}")
                        log_message(f"    - Std: {X_train_scaled[sample_col].std():.4f}")
                    X_train, X_test = X_train_scaled, X_test_scaled
                else:
                    log_message("➡️ No feature normalization applied")
                
                # Define models based on task type (using dynamic random state)
                log_message(f"🤖 Initializing {task_type} models...")
                if task_type == 'classification':
                    model_map = {
                        'logistic_regression': LogisticRegression(random_state=random_state, max_iter=1000),
                        'decision_tree': DecisionTreeClassifier(random_state=random_state),
                        'random_forest': RandomForestClassifier(random_state=random_state, n_estimators=10)
                    }
                else:
                    model_map = {
                        'linear_regression': LinearRegression(),
                        'lasso': Lasso(random_state=random_state),
                        'decision_tree': DecisionTreeRegressor(random_state=random_state),
                        'random_forest': RandomForestRegressor(random_state=random_state, n_estimators=10)
                    }
                
                available_models = list(model_map.keys())
                log_message(f"  • Available models: {available_models}")
                log_message(f"  • Selected algorithms: {algorithms}")
                
                # Train models
                model_results = []
                
                # Initialize best_score based on whether higher or lower is better for the primary metric
                higher_is_better_metrics = ['accuracy', 'precision', 'recall', 'f1', 'r2']
                lower_is_better_metrics = ['mae', 'mse', 'rmse']
                
                if primary_metric in higher_is_better_metrics:
                    best_score = float('-inf')  # Start with negative infinity for metrics where higher is better
                elif primary_metric in lower_is_better_metrics:
                    best_score = float('inf')   # Start with positive infinity for metrics where lower is better
                else:
                    # Default: assume higher is better for unknown metrics
                    best_score = float('-inf')
                    
                best_model_name = None
                log_message(f"🎯 Primary metric: '{primary_metric}' (initialized best_score to {best_score})")
                log_message("=" * 50)
                log_message("🏋️ STARTING MODEL TRAINING...")
                
                for algo in algorithms:
                    if algo in model_map:
                        try:
                            log_message(f"\n🚀 Training {algo.replace('_', ' ').title()}...")
                            
                            # Train model
                            model = model_map[algo]
                            log_message(f"  • Model parameters: {model.get_params()}")
                            model.fit(X_train, y_train)
                            log_message(f"  • ✅ Model training completed")
                            
                            # Make predictions
                            log_message(f"  • Making predictions on test set...")
                            y_pred = model.predict(X_test)
                            log_message(f"  • ✅ Predictions completed ({len(y_pred)} predictions)")
                            
                            # Calculate ALL metrics for this task type
                            log_message(f"  • Calculating metrics...")
                            metrics = {}
                            
                            if task_type == 'classification':
                                # Calculate all classification metrics
                                try:
                                    metrics['accuracy'] = float(accuracy_score(y_test, y_pred))
                                    log_message(f"    ✓ Accuracy: {metrics['accuracy']:.6f}")
                                except Exception as e:
                                    metrics['accuracy'] = 0.0
                                    log_message(f"    ✗ Accuracy calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['precision'] = float(precision_score(y_test, y_pred, average='weighted', zero_division=0))
                                    log_message(f"    ✓ Precision: {metrics['precision']:.6f}")
                                except Exception as e:
                                    metrics['precision'] = 0.0
                                    log_message(f"    ✗ Precision calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['recall'] = float(recall_score(y_test, y_pred, average='weighted', zero_division=0))
                                    log_message(f"    ✓ Recall: {metrics['recall']:.6f}")
                                except Exception as e:
                                    metrics['recall'] = 0.0
                                    log_message(f"    ✗ Recall calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['f1'] = float(f1_score(y_test, y_pred, average='weighted', zero_division=0))
                                    log_message(f"    ✓ F1-Score: {metrics['f1']:.6f}")
                                except Exception as e:
                                    metrics['f1'] = 0.0
                                    log_message(f"    ✗ F1-Score calculation failed: {e}", "warning")
                                    
                                # Calculate AUC metrics for binary and multiclass classification
                                try:
                                    # Get unique classes to determine if binary or multiclass
                                    unique_classes = len(np.unique(y_test))
                                    
                                    if unique_classes == 2:
                                        # Binary classification - use predict_proba for AUC
                                        if hasattr(model, 'predict_proba'):
                                            y_prob = model.predict_proba(X_test)[:, 1]  # Get probability of positive class
                                            metrics['auc'] = float(roc_auc_score(y_test, y_prob))
                                            log_message(f"    ✓ AUC (binary): {metrics['auc']:.6f}")
                                        else:
                                            # Fallback to decision function if available
                                            if hasattr(model, 'decision_function'):
                                                y_scores = model.decision_function(X_test)
                                                metrics['auc'] = float(roc_auc_score(y_test, y_scores))
                                                log_message(f"    ✓ AUC (binary, decision function): {metrics['auc']:.6f}")
                                            else:
                                                metrics['auc'] = 0.5  # Random classifier baseline
                                                log_message(f"    ⚠️ AUC: Model doesn't support probability prediction, using baseline: {metrics['auc']:.6f}", "warning")
                                    else:
                                        # Multiclass classification - use one-vs-rest approach
                                        if hasattr(model, 'predict_proba'):
                                            y_prob = model.predict_proba(X_test)
                                            metrics['auc'] = float(roc_auc_score(y_test, y_prob, multi_class='ovr', average='weighted'))
                                            log_message(f"    ✓ AUC (multiclass, weighted): {metrics['auc']:.6f}")
                                        else:
                                            metrics['auc'] = 0.5  # Random classifier baseline
                                            log_message(f"    ⚠️ AUC: Model doesn't support probability prediction for multiclass, using baseline: {metrics['auc']:.6f}", "warning")
                                            
                                except Exception as e:
                                    metrics['auc'] = 0.5  # Random classifier baseline
                                    log_message(f"    ✗ AUC calculation failed: {e}, using baseline: {metrics['auc']:.6f}", "warning")
                            else:
                                # Calculate all regression metrics
                                try:
                                    metrics['mae'] = float(mean_absolute_error(y_test, y_pred))
                                    log_message(f"    ✓ MAE: {metrics['mae']:.6f}")
                                except Exception as e:
                                    metrics['mae'] = float('inf')
                                    log_message(f"    ✗ MAE calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['mse'] = float(mean_squared_error(y_test, y_pred))
                                    log_message(f"    ✓ MSE: {metrics['mse']:.6f}")
                                except Exception as e:
                                    metrics['mse'] = float('inf')
                                    log_message(f"    ✗ MSE calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['rmse'] = float(np.sqrt(mean_squared_error(y_test, y_pred)))
                                    log_message(f"    ✓ RMSE: {metrics['rmse']:.6f}")
                                except Exception as e:
                                    metrics['rmse'] = float('inf')
                                    log_message(f"    ✗ RMSE calculation failed: {e}", "warning")
                                    
                                try:
                                    metrics['r2'] = float(r2_score(y_test, y_pred))
                                    log_message(f"    ✓ R²: {metrics['r2']:.6f}")
                                except Exception as e:
                                    metrics['r2'] = -float('inf')
                                    log_message(f"    ✗ R² calculation failed: {e}", "warning")
                            
                            # Verify the primary metric exists
                            if primary_metric not in metrics:
                                log_message(f"  ⚠️ WARNING: Primary metric '{primary_metric}' not found!", "warning")
                                primary_metric = list(metrics.keys())[0] if metrics else 'accuracy'
                                log_message(f"  → Using '{primary_metric}' as primary metric instead", "warning")
                            
                            current_score = metrics[primary_metric]
                            log_message(f"  🎯 Primary metric '{primary_metric}': {current_score:.6f}")
                            
                            # Define which metrics are better when higher vs lower
                            higher_is_better = ['accuracy', 'precision', 'recall', 'f1', 'r2', 'auc']
                            lower_is_better = ['mae', 'mse', 'rmse']
                            
                            if primary_metric in higher_is_better:
                                is_better = current_score > best_score
                                comparison = f"{current_score:.6f} > {best_score:.6f}"
                            elif primary_metric in lower_is_better:
                                is_better = current_score < best_score
                                comparison = f"{current_score:.6f} < {best_score:.6f}"
                            else:
                                # Default: assume higher is better for unknown metrics
                                is_better = current_score > best_score
                                comparison = f"{current_score:.6f} > {best_score:.6f}"
                            
                            log_message(f"  📈 Best model comparison: {comparison} = {is_better}")
                            
                            if is_better:
                                best_score = current_score
                                best_model_name = algo
                                log_message(f"  🏆 New best model: {algo.replace('_', ' ').title()}")
                            
                            # Store results
                            model_results.append({
                                'name': algo,
                                'display_name': algo.replace('_', ' ').title(),
                                'metrics': metrics,
                                'primary_score': current_score,
                                'created_at': datetime.now().isoformat(),
                                'is_best': False  # Will be updated later
                            })
                            
                            log_message(f"  ✅ {algo.replace('_', ' ').title()} completed successfully")
                            
                        except Exception as e:
                            log_message(f"  ❌ Failed to train {algo.replace('_', ' ').title()}: {str(e)}", "error")
                    else:
                        log_message(f"  ⚠️ Algorithm '{algo}' not available", "warning")
                
                # Mark best model
                for result in model_results:
                    result['is_best'] = result['name'] == best_model_name
                
                log_message("=" * 50)
                log_message("🏆 TRAINING SUMMARY:")
                log_message(f"  • Total models trained: {len(model_results)}")
                log_message(f"  • Primary metric used: {primary_metric}")
                if best_model_name:
                    log_message(f"  • Best model: {best_model_name.replace('_', ' ').title()}")
                    log_message(f"  • Best score: {best_score:.6f}")
                else:
                    log_message("  • No models completed successfully", "warning")
                
                log_message("🎉 TRAINING COMPLETED SUCCESSFULLY!")
                log_message("=" * 50)
                
                # Return results to JavaScript with comprehensive logs
                training_results = {
                    'success': True,
                    'results': model_results,
                    'job_id': job_data.get('id', 'unknown'),
                    'job_info': {
                        'id': job_data.get('id', 'unknown'),
                        'name': job_data.get('name', 'ML Training Job'),
                        'training_logs': training_logs,
                        'status': 'completed',
                        'models_count': len(model_results),
                        'best_model': best_model_name.replace('_', ' ').title() if best_model_name else None,
                        'best_score': best_score if best_model_name else None,
                        'primary_metric': primary_metric
                    }
                }
                
                js.handleTrainingComplete(json.dumps(training_results))
                print("✓ Training completed successfully with comprehensive logs")
                
            except Exception as e:
                import traceback
                error_msg = str(e)
                log_message(f"❌ TRAINING FAILED: {error_msg}", "error")
                log_message(f"📋 Traceback: {traceback.format_exc()}", "error")
                
                error_results = {
                    'success': False,
                    'error': error_msg,
                    'job_id': job_data.get('id', 'error') if 'job_data' in locals() else 'error',
                    'job_info': {
                        'id': job_data.get('id', 'error') if 'job_data' in locals() else 'error',
                        'name': 'Failed Training Job',
                        'training_logs': training_logs,
                        'status': 'failed',
                        'error': error_msg
                    }
                }
                js.handleTrainingComplete(json.dumps(error_results))
        
        # Make training function available to JavaScript
        js.window.train_ml_models_pyscript = train_ml_models_pyscript
        
        # Set ready flag
        js.window.pyScriptReady = True
        print("✓ PyScript ready flag set")
        
        # Try to notify JavaScript
        try:
            js.notifyPyScriptReady()
            print("✓ JavaScript notification successful")
        except Exception as e:
            print(f"JavaScript notification failed: {e}")
            
        print("PyScript initialization complete")
    </py-script>

    <script src="script.js"></script>

    <!-- Create Workspace Flyout Panel -->
    <div id="create-workspace-flyout" class="flyout-panel">
        <div class="flyout-header">
            <h2>Create a new workspace</h2>
            <button class="flyout-close-btn" onclick="closeCreateWorkspaceFlyout()">×</button>
        </div>
        <div class="flyout-content">
            <div class="form-group">
                <label for="workspace-name">Name</label>
                <input type="text" id="workspace-name" class="form-input" placeholder="Enter workspace name">
                <div id="workspace-name-error" class="error-message" style="display: none; color: #d32f2f; font-size: 12px; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label for="resource-group">Resource group</label>
                <input type="text" id="resource-group" class="form-input" value="ResourceGroup1">
            </div>
            <div class="flyout-actions">
                <button class="btn-secondary" onclick="closeCreateWorkspaceFlyout()">Cancel</button>
                <button class="btn-primary" onclick="createNewWorkspace()">Create</button>
            </div>
        </div>
    </div>
</body>
</html>